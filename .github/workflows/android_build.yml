name: Build Android APK

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
    
    - name: Debug - List files
      run: |
        echo "Current directory structure:"
        ls -la
        echo "Android directory contents:"
        if [ -d "android" ]; then
          ls -la android/
        else
          echo "No android directory found!"
        fi
    
    - name: Create basic React Native files if missing
      run: |
        # Create package.json if missing
        if [ ! -f "package.json" ]; then
          echo "Creating package.json..."
          cat > package.json << 'EOF'
          {
            "name": "quotes-app",
            "version": "1.0.0",
            "private": true,
            "scripts": {
              "android": "react-native run-android",
              "start": "react-native start"
            },
            "dependencies": {
              "react": "18.2.0",
              "react-native": "0.73.0"
            }
          }
          EOF
        fi
        
        # Create android directory structure if missing
        if [ ! -d "android" ]; then
          echo "Creating Android project structure..."
          
          # Create minimal Android project
          mkdir -p android/app/src/main/java/com/quotesapp
          mkdir -p android/app/src/main/res
          mkdir -p android/gradle/wrapper
          
          # Create gradle wrapper files
          cat > android/gradle/wrapper/gradle-wrapper.properties << 'EOF'
          distributionBase=GRADLE_USER_HOME
          distributionPath=wrapper/dists
          distributionUrl=https\://services.gradle.org/distributions/gradle-7.5.1-all.zip
          zipStoreBase=GRADLE_USER_HOME
          zipStorePath=wrapper/dists
          EOF
          
          # Download gradlew script
          curl -o android/gradlew https://raw.githubusercontent.com/gradle/gradle/master/gradlew
          chmod +x android/gradlew
          
          echo "Created basic Android structure"
        else
          echo "Android directory exists"
        fi
    
    - name: Check and fix gradlew
      run: |
        if [ -d "android" ]; then
          cd android
          
          # Check if gradlew exists
          if [ ! -f "gradlew" ]; then
            echo "gradlew not found, downloading..."
            curl -o gradlew https://raw.githubusercontent.com/gradle/gradle/master/gradlew
            chmod +x gradlew
            echo "Downloaded gradlew"
          else
            echo "gradlew exists"
            chmod +x gradlew
          fi
          
          # Check gradle wrapper properties
          if [ ! -f "gradle/wrapper/gradle-wrapper.properties" ]; then
            mkdir -p gradle/wrapper
            cat > gradle/wrapper/gradle-wrapper.properties << 'EOF'
            distributionBase=GRADLE_USER_HOME
            distributionPath=wrapper/dists
            distributionUrl=https\://services.gradle.org/distributions/gradle-7.5.1-all.zip
            zipStoreBase=GRADLE_USER_HOME
            zipStorePath=wrapper/dists
            EOF
          fi
        else
          echo "No android directory!"
        fi
    
    - name: Install Node dependencies
      run: |
        if [ -f "package.json" ]; then
          npm install
        else
          echo "No package.json found"
        fi
    
    - name: Build Android APK
      run: |
        if [ -d "android" ]; then
          cd android
          
          # Create minimal build.gradle files if missing
          if [ ! -f "build.gradle" ]; then
            echo "Creating root build.gradle..."
            cat > build.gradle << 'EOF'
            buildscript {
                ext {
                    buildToolsVersion = "33.0.0"
                    minSdkVersion = 21
                    compileSdkVersion = 33
                    targetSdkVersion = 33
                    kotlinVersion = "1.8.0"
                }
                repositories {
                    google()
                    mavenCentral()
                }
                dependencies {
                    classpath("com.android.tools.build:gradle:7.3.1")
                    classpath("com.facebook.react:react-native-gradle-plugin")
                }
            }
            EOF
          fi
          
          if [ ! -f "app/build.gradle" ]; then
            mkdir -p app
            echo "Creating app build.gradle..."
            cat > app/build.gradle << 'EOF'
            apply plugin: "com.android.application"
            apply plugin: "com.facebook.react"
            
            react {
                entryFile = file("../../index.js")
            }
            
            android {
                ndkVersion rootProject.ext.ndkVersion
                compileSdkVersion rootProject.ext.compileSdkVersion
                
                defaultConfig {
                    applicationId "com.quotesapp"
                    minSdkVersion rootProject.ext.minSdkVersion
                    targetSdkVersion rootProject.ext.targetSdkVersion
                    versionCode 1
                    versionName "1.0"
                }
                
                buildTypes {
                    debug {
                        signingConfig signingConfigs.debug
                    }
                    release {
                        signingConfig signingConfigs.debug
                    }
                }
            }
            
            dependencies {
                implementation("com.facebook.react:react-android")
                implementation("com.facebook.react:hermes-android")
            }
            EOF
          fi
          
          # Now build
          echo "Building APK..."
          ./gradlew assembleDebug
        else
          echo "Android directory not found!"
          exit 1
        fi
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: app-debug-apk
        path: android/app/build/outputs/apk/debug/*.apk
        retention-days: 7
